# @name IPC  performance test script.
# @desc Test does IPC Performance test.

# @requires ipc 

IPC_S_FUNC_RPMSG_RPC source ipc_funcs.sh; rm_ipc_mods; setup_firmware '*-fw-rpmsg-rpc-test.*'; ins_ipc_mods rpmsg_rpc; num_proc=$(get_num_remote_procs); rpmsg_rpc_test -p $num_proc
IPC_S_FUNC_RPMSG_RPC_KILL source ipc_funcs.sh; rm_ipc_mods; setup_firmware '*-fw-rpmsg-rpc-test.*'; ins_ipc_mods rpmsg_rpc; num_proc=$(get_num_remote_procs); rpmsg_rpc_test -p $num_proc -f triple -s 5; rpmsg_rpc_test -p $num_proc
IPC_S_FUNC_RPMSG_RPC_MMU_FAULT source ipc_funcs.sh; rm_ipc_mods; setup_firmware '*-fw-rpmsg-rpc-test.*'; ins_ipc_mods rpmsg_rpc; num_proc=$(get_num_remote_procs); rpmsg_rpc_test -p $num_proc -m 1; rpmsg_rpc_test -p $num_proc
IPC_S_FUNC_RPMSG_RPC_MMU_FAULT_FIRST_MSG source ipc_funcs.sh; rm_ipc_mods; setup_firmware '*-fw-rpmsg-rpc-test.*'; ins_ipc_mods rpmsg_rpc; num_proc=$(get_num_remote_procs); rpmsg_rpc_test -p $num_proc -m 0; rpmsg_rpc_test -p $num_proc
IPC_S_FUNC_RPMSG_RPC_MMU_FAULT_LAST_MSG source ipc_funcs.sh; rm_ipc_mods; setup_firmware '*-fw-rpmsg-rpc-test.*'; ins_ipc_mods rpmsg_rpc; num_proc=$(get_num_remote_procs); rpmsg_rpc_test -p $num_proc -m 2; rpmsg_rpc_test -p $num_proc
IPC_S_FUNC_RPMSG_PROTO source ipc_funcs.sh; rm_ipc_mods; setup_firmware '*-fw-rpmsg-proto-msgq-app-test.*'; ins_ipc_mods rpmsg_proto; start_lad  || die "lad did not start" ; num_proc=$(get_num_remote_procs); rpmsg_proto_msgqapp_test $num_proc
IPC_S_FUNC_RPMSG_PROTO_KILL source ipc_funcs.sh; rm_ipc_mods; setup_firmware '*-fw-rpmsg-proto-msgq-app-test.*'; ins_ipc_mods rpmsg_proto; start_lad  || die "lad did not start" ; num_proc=$(get_num_remote_procs); rpmsg_proto_msgqapp_test $num_proc 8000 2; rpmsg_proto_msgqapp_test $num_proc
IPC_S_PERF_RPMSG_PROTO_BENCH_8BYTES source ipc_funcs.sh; rm_ipc_mods; setup_firmware '*-fw-rpmsg-proto-msgq-app-test.*'; ins_ipc_mods rpmsg_proto; start_lad  || die "lad did not start" ; num_proc=$(get_num_remote_procs); rpmsg_proto_msgqbench_test $num_proc
IPC_S_PERF_RPMSG_PROTO_BENCH_228BYTES source ipc_funcs.sh; rm_ipc_mods; setup_firmware '*-fw-rpmsg-proto-msgq-app-test.*'; ins_ipc_mods rpmsg_proto; start_lad  || die "lad did not start" ; num_proc=$(get_num_remote_procs); rpmsg_proto_msgqbench_test $num_proc 228
IPC_S_PERF_RPMSG_PROTO_BENCH_456BYTES source ipc_funcs.sh; rm_ipc_mods; setup_firmware '*-fw-rpmsg-proto-msgq-app-test.*'; ins_ipc_mods rpmsg_proto; start_lad  || die "lad did not start" ; num_proc=$(get_num_remote_procs); rpmsg_proto_msgqbench_test $num_proc 456
IPC_S_FUNC_RPMSG_PROTO_MULTI source ipc_funcs.sh; rm_ipc_mods; setup_firmware '*-fw-rpmsg-proto-msgq-multi-test.*'; ins_ipc_mods rpmsg_proto; start_lad  || die "lad did not start" ; rpmsg_proto_msgqmulti_test 25 1000
IPC_S_FUNC_RPMSG_PROTO_MULTI_KILL source ipc_funcs.sh; rm_ipc_mods; setup_firmware '*-fw-rpmsg-proto-msgq-multi-test.*'; ins_ipc_mods rpmsg_proto; start_lad  || die "lad did not start" ; rpmsg_proto_msgqmulti_test 25 1000 3; rpmsg_proto_msgqmulti_test 25 1000
IPC_S_FUNC_RPMSG_SAMPLE_CLIENT source ipc_funcs.sh; rm_ipc_mods; setup_firmware '*-fw-rpmsg-ping-tasks.*'; ins_ipc_mods; num_proc=$(get_num_remote_procs); rpmsg_client_sample_test $num_proc 10
IPC_S_FUNC_RPMSG_RPC_RECOVERY_SINGLE_PROC source ipc_funcs.sh; rm_ipc_mods; setup_firmware '*-fw-rpmsg-rpc-test.*'; ins_ipc_mods rpmsg_rpc; num_proc=$(get_num_remote_procs); rec_cmd=$(rpmsg_recovery_event); rpmsg_rpc_test -p 1 -f triple -s 5 -c "$rec_cmd" ; sleep 5; rpmsg_rpc_test -p $num_proc
IPC_S_FUNC_RPMSG_RPC_RECOVERY source ipc_funcs.sh; rm_ipc_mods; setup_firmware '*-fw-rpmsg-rpc-test.*'; ins_ipc_mods rpmsg_rpc; num_proc=$(get_num_remote_procs); rec_cmd=$(rpmsg_recovery_event); rpmsg_rpc_test -p $num_proc -f triple -s 5 -c "$rec_cmd" ; sleep 5; rpmsg_rpc_test -p $num_proc
IPC_S_FUNC_RPMSG_RPC_KILL_RECOVERY source ipc_funcs.sh; rm_ipc_mods; setup_firmware '*-fw-rpmsg-rpc-test.*'; ins_ipc_mods rpmsg_rpc; num_proc=$(get_num_remote_procs); rec_cmd=$(rpmsg_recovery_event); rpmsg_rpc_test -p $num_proc -f triple -s 5; rpmsg_rpc_test -p $num_proc -f triple -s 5 -c "$rec_cmd" ; sleep 5; rpmsg_rpc_test -p $num_proc
IPC_S_FUNC_RPMSG_PROTO_RECOVERY source ipc_funcs.sh; rm_ipc_mods; setup_firmware '*-fw-rpmsg-proto-msgq-app-test.*'; ins_ipc_mods rpmsg_proto; start_lad  || die "lad did not start" ; num_proc=$(get_num_remote_procs); rec_cmd=$(rpmsg_recovery_event); rpmsg_proto_msgqapp_test $num_proc 8000 5 "$rec_cmd"; sleep 5; rpmsg_proto_msgqapp_test $num_proc
IPC_S_FUNC_RPMSG_PROTO_KILL_RECOVERY source ipc_funcs.sh; rm_ipc_mods; setup_firmware '*-fw-rpmsg-proto-msgq-app-test.*'; ins_ipc_mods rpmsg_proto; start_lad  || die "lad did not start" ; num_proc=$(get_num_remote_procs); rec_cmd=$(rpmsg_recovery_event); rpmsg_proto_msgqapp_test $num_proc 8000 2; rpmsg_proto_msgqapp_test $num_proc 8000 5 "$rec_cmd"; sleep 5; rpmsg_proto_msgqapp_test $num_proc

IPC_S_FUNC_PRU_LOAD source ipc_funcs.sh; prus=( $(list_prus) ); toggle_prus unbind ${prus[@]}; modprobe -r pruss_remoteproc; setup_firmware '*MAC_Multiply_Accum*'; dmesg -c > /dev/null; modprobe pruss_remoteproc; sleep 5; probe_info=$(dmesg); num_loaded=$(echo -e "$probe_info" | grep -c -i 'PRU rproc node.*probed successfully'); [[ $num_loaded -eq ${#prus[@]} ]] || die "PRUs did not load successfully $probe_info ====== $num_loaded != ${#prus[@]} ======"
