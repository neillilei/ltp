# @name ALE Table test using SWITCH-CONFIG 
# @desc Checks default entries in ALE table and verifies addition and deletion of multicast entries.
# @requires net

ETH-SWITCH-CONFIG_XS_FUNC_DUMP-UNICAST source 'common.sh'; dual_mac=`find /proc/device-tree/ -name dual_emac`; if [[ ! -z "$dual_mac" ]]; then die "This is a dual mac case, use a different dtb to test switch mode"; fi; iface=`get_eth_iface_name.sh` || die "error getting eth interface name"; mac_address=`cat /sys/class/net/$iface/address`; if [ -z "`switch-config -d|grep -i ucast| grep $mac_address`" ]; then die "TEST has failed since there is no unicast entry with the mac address of ethernet interface in ALE table."; fi
ETH-SWITCH-CONFIG_XS_FUNC_DUMP-MCAST source 'common.sh'; dual_mac=`find /proc/device-tree/ -name dual_emac`; if [[ ! -z "$dual_mac" ]]; then die "This is a dual mac case, use a different dtb to test switch mode"; fi; if [ -z "`switch-config -d|grep -i mcast|grep -i "ff:ff:ff:ff:ff:ff"`" ]; then die "TEST has failed since there is no default multicast entry in ALE table."; fi
ETH-SWITCH-CONFIG_XS_FUNC_DUMP-VLAN source 'common.sh'; dual_mac=`find /proc/device-tree/ -name dual_emac`; if [[ ! -z "$dual_mac" ]]; then die "This is a dual mac case, use a different dtb to test switch mode"; fi; if [ -z "`switch-config -d|grep -i vlan|grep -i "vid\s*=\s*0"`" ]; then die "TEST has failed since there is no default vlan entry in ALE table."; fi
ETH-SWITCH-CONFIG_XS_FUNC_ADD-DELETE-MCAST source 'common.sh'; dual_mac=`find /proc/device-tree/ -name dual_emac`; if [[ ! -z "$dual_mac" ]]; then die "This is a dual mac case, use a different dtb to test switch mode"; fi; test_multi_addr=01:00:5E:00:55:55; if [ ! -z "`switch-config -d|grep -i $test_multi_addr`" ]; then die "Non-default multicast address $test_multi_addr is already in ALE table. Double-check or test with a different mcast address"; fi; do_cmd "switch-config --add-multi $test_multi_addr --port 7"; if [ -z "`switch-config -d|grep -i mcast|grep -i $test_multi_addr|grep -i "port_mask\s*=\s*0x7"`" ]; then die "New multicast entry is not present in ALE table or port mask is incorrect."; fi; do_cmd "switch-config -x $test_multi_addr"; if [ ! -z "`switch-config -d|grep -i mcast|grep -i $test_multi_addr`" ]; then die "Switch-config delete is not working correctly. Check manually."; fi
