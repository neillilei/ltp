# @name TI Decoder Tests
# @desc Test functionality of Texas Instruments' video decoders
# @requires tidec
# @setup_requires

TIDEC_S_FUNC_DECODE_AUD_MW_E.264 source 'ti_decode.sh'; F=$(mktemp); run_tidec_decode -i /usr/share/ti/tidec-decode/AUD_MW_E.264 -o $F || die "Decode operation did not complete successfully"; MD5=$(md5sum ${F}_00.raw) ; echo $MD5 | grep e83a38c08bf61830530435dfee134ca9 || die "decoded file does not match expected md5sum"

TIDEC_S_FUNC_DECODE_PROFILER_AUD_MW_E.264 source 'ti_decode.sh'; F=$(mktemp); run_tidec_decode -i /usr/share/ti/tidec-decode/AUD_MW_E.264 -o $F || die "Decode operation did not complete successfully"; MD5=$(md5sum ${F}_00.raw) ; echo $MD5 | grep e83a38c08bf61830530435dfee134ca9 || die "decoded file does not match expected md5sum"; output=`dmesg`; echo "OUTPUT is $output"; if [[ $output != *"picture buf decode time is"* ]]; then die "Expected output from profiler is not found";fi

TIDEC_S_FUNC_DELAYED_DECODE_AUD_MW_E.264 source 'ti_decode.sh'; F=$(mktemp); do_cmd "sleep 60"; run_tidec_decode -i /usr/share/ti/tidec-decode/AUD_MW_E.264 -o $F || die "Decode operation did not complete successfully"; MD5=$(md5sum ${F}_00.raw) ; echo $MD5 | grep e83a38c08bf61830530435dfee134ca9 || die "decoded file does not match expected md5sum"

TIDEC_S_FUNC_DECODE_BA1_FT_C.264 source 'ti_decode.sh'; F=$(mktemp); run_tidec_decode -i /usr/share/ti/tidec-decode/BA1_FT_C.264 -o $F || die "Decode operation did not complete successfully"; MD5=$(md5sum ${F}_00.raw) ; echo $MD5 | grep c5e3240f286b6bb8faffa9180af75352 || die "decoded file does not match expected md5sum"

TIDEC_S_FUNC_DECODE_BAMQ1_JVC_C.264 source 'ti_decode.sh'; F=$(mktemp); run_tidec_decode -i /usr/share/ti/tidec-decode/BAMQ1_JVC_C.264 -o $F || die "Decode operation did not complete successfully"; MD5=$(md5sum ${F}_00.raw) ; echo $MD5 | grep 9d58ded839ed274299b1b4626da191cc || die "decoded file does not match expected md5sum"

TIDEC_S_FUNC_DECODE_BAMQ2_JVC_C.264 source 'ti_decode.sh'; F=$(mktemp); run_tidec_decode -i /usr/share/ti/tidec-decode/BAMQ2_JVC_C.264 -o $F || die "Decode operation did not complete successfully"; MD5=$(md5sum ${F}_00.raw) ; echo $MD5 | grep 8b4837b2f33b86f5d15d77aed3b2d9a0 || die "decoded file does not match expected md5sum"

TIDEC_S_FUNC_DECODE_BA_MW_D.264  source 'ti_decode.sh'; F=$(mktemp); run_tidec_decode -i /usr/share/ti/tidec-decode/BA_MW_D.264 -o $F || die "Decode operation did not complete successfully"; MD5=$(md5sum ${F}_00.raw) ; echo $MD5 | grep 9073f914a6b6da67552ab76cde1bdf85 || die "decoded file does not match expected md5sum"

TIDEC_S_FUNC_DECODE_BANM_MW_D.264 source 'ti_decode.sh'; F=$(mktemp); run_tidec_decode -i /usr/share/ti/tidec-decode/BANM_MW_D.264 -o $F || die "Decode operation did not complete successfully"; MD5=$(md5sum ${F}_00.raw) ; echo $MD5 | grep 2240a60ad26bfa4af57bd461b8680909 || die "decoded file does not match expected md5sum"

TIDEC_S_FUNC_DECODE_YUVFULL_544X480.264 source 'ti_decode.sh'; F=$(mktemp); run_tidec_decode -i /usr/share/ti/tidec-decode/yuvfull_544x480.264 -o $F || die "Decode operation did not complete successfully"; MD5=$(md5sum ${F}_00.raw) ; echo $MD5 | grep f945e5bdccf47161c385bf8060eb72a9 || die "decoded file does not match expected md5sum"

TIDEC_S_FUNC_DECODE_FOREMAN_128X64.h265 source 'ti_decode.sh'; F=$(mktemp); run_tidec_decode -i /usr/share/ti/tidec-decode/foreman_128x64_128x64_8bit_10frames_ctu32_qp32_Inter_SAO_AMP_Debl_NoPCM.h265 -o $F || die "Decode operation did not complete successfully"; MD5=$(md5sum ${F}_00.raw) ; echo $MD5 | grep 8d5a01e85303c2e0021b85754ea801e0 || die "decoded file does not match expected md5sum"

TIDEC_S_FUNC_DECODE_AKIYO_QCIF_420_HP_LEV10_DB.264 source 'ti_decode.sh'; F=$(mktemp); run_tidec_decode -i /usr/share/ti/tidec-decode/akiyo_qcif_420_hp_lev10_db_BFrame.264 -o $F || die "Decode operation did not complete successfully"; MD5=$(md5sum ${F}_00.raw) ; echo $MD5 | grep 81b9093edd64f47a06ad4e89298ac245 || die "decoded file does not match expected md5sum"

TIDEC_S_FUNC_DECODE_H264_176_144_5_CHROMA2_422_HIGH_25FR.264 source 'ti_decode.sh'; F=$(mktemp); run_tidec_decode -i /usr/share/ti/tidec-decode/h264_176_144_5_chroma2_422_high_25fr.264 -o $F || die "Decode operation did not complete successfully"; MD5=$(md5sum ${F}_00.raw) ; echo $MD5 | grep 6ebdae0b644e52c19f17bde07cc82151 || die "decoded file does not match expected md5sum"

TIDEC_S_FUNC_DECODE_TEST_ERR_CONS_176X144.264 source 'ti_decode.sh'; F=$(mktemp); run_tidec_decode -i /usr/share/ti/tidec-decode/test_err_cons_176x144.264 -o $F || die "Decode operation did not complete successfully"; MD5=$(md5sum ${F}_00.raw) ; echo $MD5 | grep f9b121ef0a2f6930c200fa06f9994f0d || die "decoded file does not match expected md5sum"

TIDEC_S_FUNC_DECODE_WB_10BIT_QP21_I-ONLY_1920X1088_10FR.264 source 'ti_decode.sh'; F=$(mktemp); run_tidec_decode -i /usr/share/ti/tidec-decode/WB_10bit_QP21_I-Only_1920x1088_10fr.264 -o $F || die "Decode operation did not complete successfully"; MD5=$(md5sum ${F}_00.raw) ; echo $MD5 | grep 2a430df43a0bfc8659e054fdff82e279 || die "decoded file does not match expected md5sum"

TIDEC_S_FUNC_DECODE_CROWDRUN_352X288_P25_CGRLEVELS_SINC_FILTER_SVTDEC05_10BIT_422P_30FR.265 source 'ti_decode.sh'; F=$(mktemp); run_tidec_decode -i /usr/share/ti/tidec-decode/CrowdRun_352x288_p25_CgrLevels_SINC_FILTER_SVTdec05_10bit_422p_30fr.265 -o $F || die "Decode operation did not complete successfully"; MD5=$(md5sum ${F}_00.raw) ; echo $MD5 | grep c1c1bff7914c21a033af085f611b3ea5 || die "decoded file does not match expected md5sum"

TIDEC_S_FUNC_DECODE_VTC1NW_422_CIF_8BIT_352X288.265  source 'ti_decode.sh'; F=$(mktemp); run_tidec_decode -i /usr/share/ti/tidec-decode/vtc1nw_422_cif_8bit_352x288.265 -o $F || die "Decode operation did not complete successfully"; MD5=$(md5sum ${F}_00.raw) ; echo $MD5 | grep caad359d9a5b962b4e82472fa87c0ef0 || die "decoded file does not match expected md5sum"

TIDEC_S_FUNC_DECODE_NETFLIX_FOODMARKET_HIGH_4096X2160_IPB_40MBPS_5.1.264  source 'ti_decode.sh'; F=$(mktemp); run_tidec_decode -i /usr/share/ti/tidec-decode/Netflix_FoodMarket_high_4096x2160_IPB_40mbps_5.1.264 -f 10 -o $F || die "Decode operation did not complete successfully"; MD5=$(md5sum ${F}_00.raw) ; echo $MD5 | grep 89dade3092a67554cb398f98a27320b2 || die "decoded file does not match expected md5sum"

TIDEC_S_FUNC_DECODE_NETFLIX_FOODMARKET_4096X2160_60FPS_IPB_51LEVEL_MAIN_40MBPS.265  source 'ti_decode.sh'; F=$(mktemp); run_tidec_decode -i /usr/share/ti/tidec-decode/Netflix_FoodMarket_4096x2160_60fps_IPB_51level_main_40mbps.265 -f 10 -o $F || die "Decode operation did not complete successfully"; MD5=$(md5sum ${F}_00.raw) ; echo $MD5 | grep d685b93d93b304140b452d415562783b || die "decoded file does not match expected md5sum"

TIDEC_M_FUNC_DECODE_BACK_TO_BACK_AKIYO_QCIF source 'ti_decode.sh'; F=$(mktemp); for LOOP in 0 1 2 3 4 ; do run_tidec_decode -i /usr/share/ti/tidec-decode/akiyo_qcif_420_hp_lev10_db_BFrame.264 -o $F || die "Decode operation did not complete successfully"; MD5=$(md5sum ${F}_00.raw) ; echo $MD5 | grep 81b9093edd64f47a06ad4e89298ac245 || die "decoded file does not match expected md5sum" ; done

TIDEC_S_FUNC_GST_DECODE_AUD_MW_E.264 source 'ti_decode.sh'; insert_video_modules; gst-launch-1.0 filesrc location=/usr/share/ti/tidec-decode/AUD_MW_E.264 ! h264parse ! v4l2h264dec ! video/x-raw,format='(string)'NV12 ! kmssink || die "GStreamer operation did not complete successfully"

TIDEC_S_FUNC_GST_DECODE_FOREMAN_128X64.h265 source 'ti_decode.sh'; insert_video_modules; gst-launch-1.0 playbin uri=file:///usr/share/ti/tidec-decode/foreman_128x64_128x64_8bit_10frames_ctu32_qp32_Inter_SAO_AMP_Debl_NoPCM.h265 video-sink=kmssink || die "GStreamer operation did not complete successfully"

TIDEC_S_FUNC_GST_DECODE_FAKESINK_AUD_MW_E.264 source 'ti_decode.sh'; insert_video_modules; gst-launch-1.0 filesrc location=/usr/share/ti/tidec-decode/AUD_MW_E.264 ! h264parse ! v4l2h264dec ! video/x-raw,format='(string)'NV12 ! fakesink || die "GStreamer operation did not complete successfully"

TIDEC_S_FUNC_GST_DECODE_FILESINK_AUD_MW_E.264 source 'ti_decode.sh'; insert_video_modules; gst-launch-1.0 filesrc location=/usr/share/ti/tidec-decode/AUD_MW_E.264 ! h264parse ! v4l2h264dec ! video/x-raw,format='(string)'NV12 ! filesink location=/tmp/AUD_MW_E.yuv || die "GStreamer operation did not complete successfully"


